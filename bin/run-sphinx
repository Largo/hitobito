#!/bin/bash

set -e

if [ -z $SPHINX_INTERVAL_TIME ]; then
  SPHINX_INTERVAL_TIME=3600 # 600 = 10 mins, 3600 = 1 hour
fi

if [ -z $SPHINX_CONFIG_PATH ]; then
    SPHINX_CONFIG_PATH=/opt/sphinx/conf/sphinx.conf
fi

function formatted_date {
    date +"%Y-%m-%dT%H:%M:%S"
}

function run_indexer {
  /usr/bin/indexer --config $SPHINX_CONFIG_PATH --all --rotate
}

function scheduled_indexing {
  if [[ "$SPHINX_SKIP_INITIAL_INDEX" != "1" ]]; then
    run_indexer
  fi

  while :
  do
    # We sleep first before starting the indexer because
    # rake ts:index below will already start an index run.
    sleep $SPHINX_INTERVAL_TIME
    echo "$(formatted_date): Starting indexer ..."
    run_indexer
    echo "$(formatted_date): ... indexing done"
  done
}

# make sure binlog directory exists
binlog_path=$(grep binlog_path $SPHINX_CONFIG_PATH | cut -d'=' -f2-)
mkdir -p $binlog_path

# start indexer and sphinx daemon
scheduled_indexing & \
/usr/bin/searchd --config $SPHINX_CONFIG_PATH --nodetach
